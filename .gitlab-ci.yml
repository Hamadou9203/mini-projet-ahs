image: docker:latest
services:
    - name: docker:dind
      alias: flask

stages:
    - lint
    - build
    - scan
    - release

variables:
    DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

#check app code
linter_flake8:
   stage: lint
   script:
     - apk add --no-cache python3 py3-pip
     - python3 -m venv venv  # Cr√©er un environnement virtuel
     - source venv/bin/activate  # Activer l'environnement virtuel
     - pip install flake8
     - flake8 --ignore=E501,E303 ./webapp/*.py

# check Dockerfile
linter_hadolink:
    stage: lint
    script:
      - docker run --rm -i hadolint/hadolint < Dockerfile


compilation:
  # Use the official docker image.
  stage: build
  
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  # All branches are tagged with $DOCKER_IMAGE_NAME (defaults to commit ref slug)
  # Default branch is also tagged with `latest`
  script:
    - docker build  -t "$DOCKER_IMAGE_NAME" .
   
    - docker save -o flask-app.war "$DOCKER_IMAGE_NAME"
  # Run this job in a branch where a Dockerfile exists
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - Dockerfile
  artifacts:
    paths:
        - flask-app.war


scanning:
  stage: scan
  script:
    - docker load -i flask-app.war 
    - docker run --rm aquasec/trivy image "$DOCKER_IMAGE_NAME" --no-progress --severity HIGH


package:
 stage: release
 before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
 only:
     - master
     - merge_requests
 script:
   - docker load -i flask-app.war 
   - docker push "$DOCKER_IMAGE_NAME"
   # Default branch is also tagged with `latest`
   - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        docker tag "$DOCKER_IMAGE_NAME" "$CI_REGISTRY_IMAGE:latest"
        docker push "$CI_REGISTRY_IMAGE:latest"
      fi

